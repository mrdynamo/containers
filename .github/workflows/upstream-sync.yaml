---
name: Upstream Sync

"on":
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-upstream:
    name: Check Upstream Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # v6.0.2
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check twitch-channel-points-miner Upstream
        id: check-tcpm
        run: |
          # Fetch the latest commit SHA from upstream
          UPSTREAM_REPO="mpforce1/Twitch-Channel-Points-Miner"
          UPSTREAM_SHA=$(
            curl -s \
              "https://api.github.com/repos/${UPSTREAM_REPO}/commits/main" \
              | jq -r '.sha'
          )

          if [ -z "$UPSTREAM_SHA" ] || [ "$UPSTREAM_SHA" = "null" ]; then
            echo "Failed to fetch upstream SHA"
            exit 1
          fi

          # Read the stored SHA
          SHA_FILE=".github/upstream-shas/twitch-channel-points-miner.txt"
          STORED_SHA=$(cat "$SHA_FILE")

          echo "Upstream SHA: $UPSTREAM_SHA"
          echo "Stored SHA: $STORED_SHA"

          if [ "$UPSTREAM_SHA" != "$STORED_SHA" ]; then
            echo "Upstream has been updated!"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          else
            echo "No updates detected"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Stored SHA
        if: steps.check-tcpm.outputs.updated == 'true'
        run: |
          SHA_FILE=".github/upstream-shas/twitch-channel-points-miner.txt"
          NEW_SHA="${{ steps.check-tcpm.outputs.new_sha }}"
          echo "$NEW_SHA" > "$SHA_FILE"
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add "$SHA_FILE"
          git commit -m \
            "chore: update twitch-channel-points-miner upstream SHA"
          git push

      - name: Trigger Release Workflow
        if: steps.check-tcpm.outputs.updated == 'true'
        # v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yaml',
              ref: 'main',
              inputs: {
                app: 'twitch-channel-points-miner',
                release: 'true'
              }
            });
            const msg = 'Triggered release workflow for ';
            console.log(msg + 'twitch-channel-points-miner');
